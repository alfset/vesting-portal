{"ast":null,"code":"import { EventEmitter } from \"events\";\nimport fetch from \"cross-fetch\";\nimport { safeJsonParse, safeJsonStringify } from \"@walletconnect/safe-json\";\nimport { formatJsonRpcError, isHttpUrl, parseConnectionError } from \"@walletconnect/jsonrpc-utils\";\nconst DEFAULT_HTTP_HEADERS = {\n  Accept: \"application/json\",\n  \"Content-Type\": \"application/json\"\n};\nconst DEFAULT_HTTP_METHOD = \"POST\";\nconst DEFAULT_FETCH_OPTS = {\n  headers: DEFAULT_HTTP_HEADERS,\n  method: DEFAULT_HTTP_METHOD\n};\nconst EVENT_EMITTER_MAX_LISTENERS_DEFAULT = 10;\nexport class HttpConnection {\n  constructor(url) {\n    let disableProviderPing = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    this.url = url;\n    this.disableProviderPing = disableProviderPing;\n    this.events = new EventEmitter();\n    this.isAvailable = false;\n    this.registering = false;\n    if (!isHttpUrl(url)) {\n      throw new Error(\"Provided URL is not compatible with HTTP connection: \".concat(url));\n    }\n    this.url = url;\n    this.disableProviderPing = disableProviderPing;\n  }\n  get connected() {\n    return this.isAvailable;\n  }\n  get connecting() {\n    return this.registering;\n  }\n  on(event, listener) {\n    this.events.on(event, listener);\n  }\n  once(event, listener) {\n    this.events.once(event, listener);\n  }\n  off(event, listener) {\n    this.events.off(event, listener);\n  }\n  removeListener(event, listener) {\n    this.events.removeListener(event, listener);\n  }\n  async open() {\n    let url = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.url;\n    await this.register(url);\n  }\n  async close() {\n    if (!this.isAvailable) {\n      throw new Error(\"Connection already closed\");\n    }\n    this.onClose();\n  }\n  async send(payload, context) {\n    if (!this.isAvailable) {\n      await this.register();\n    }\n    try {\n      const body = safeJsonStringify(payload);\n      const res = await fetch(this.url, Object.assign(Object.assign({}, DEFAULT_FETCH_OPTS), {\n        body\n      }));\n      const data = await res.json();\n      this.onPayload({\n        data\n      });\n    } catch (e) {\n      this.onError(payload.id, e);\n    }\n  }\n  async register() {\n    let url = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.url;\n    if (!isHttpUrl(url)) {\n      throw new Error(\"Provided URL is not compatible with HTTP connection: \".concat(url));\n    }\n    if (this.registering) {\n      const currentMaxListeners = this.events.getMaxListeners();\n      if (this.events.listenerCount(\"register_error\") >= currentMaxListeners || this.events.listenerCount(\"open\") >= currentMaxListeners) {\n        this.events.setMaxListeners(currentMaxListeners + 1);\n      }\n      return new Promise((resolve, reject) => {\n        this.events.once(\"register_error\", error => {\n          this.resetMaxListeners();\n          reject(error);\n        });\n        this.events.once(\"open\", () => {\n          this.resetMaxListeners();\n          if (typeof this.isAvailable === \"undefined\") {\n            return reject(new Error(\"HTTP connection is missing or invalid\"));\n          }\n          resolve();\n        });\n      });\n    }\n    this.url = url;\n    this.registering = true;\n    try {\n      if (!this.disableProviderPing) {\n        const body = safeJsonStringify({\n          id: 1,\n          jsonrpc: \"2.0\",\n          method: \"test\",\n          params: []\n        });\n        await fetch(url, Object.assign(Object.assign({}, DEFAULT_FETCH_OPTS), {\n          body\n        }));\n      }\n      this.onOpen();\n    } catch (e) {\n      const error = this.parseError(e);\n      this.events.emit(\"register_error\", error);\n      this.onClose();\n      throw error;\n    }\n  }\n  onOpen() {\n    this.isAvailable = true;\n    this.registering = false;\n    this.events.emit(\"open\");\n  }\n  onClose() {\n    this.isAvailable = false;\n    this.registering = false;\n    this.events.emit(\"close\");\n  }\n  onPayload(e) {\n    if (typeof e.data === \"undefined\") return;\n    const payload = typeof e.data === \"string\" ? safeJsonParse(e.data) : e.data;\n    this.events.emit(\"payload\", payload);\n  }\n  onError(id, e) {\n    const error = this.parseError(e);\n    const message = error.message || error.toString();\n    const payload = formatJsonRpcError(id, message);\n    this.events.emit(\"payload\", payload);\n  }\n  parseError(e) {\n    let url = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.url;\n    return parseConnectionError(e, url, \"HTTP\");\n  }\n  resetMaxListeners() {\n    if (this.events.getMaxListeners() > EVENT_EMITTER_MAX_LISTENERS_DEFAULT) {\n      this.events.setMaxListeners(EVENT_EMITTER_MAX_LISTENERS_DEFAULT);\n    }\n  }\n}\nexport default HttpConnection;","map":{"version":3,"names":["EventEmitter","fetch","safeJsonParse","safeJsonStringify","formatJsonRpcError","isHttpUrl","parseConnectionError","DEFAULT_HTTP_HEADERS","Accept","DEFAULT_HTTP_METHOD","DEFAULT_FETCH_OPTS","headers","method","EVENT_EMITTER_MAX_LISTENERS_DEFAULT","HttpConnection","constructor","url","disableProviderPing","arguments","length","undefined","events","isAvailable","registering","Error","concat","connected","connecting","on","event","listener","once","off","removeListener","open","register","close","onClose","send","payload","context","body","res","Object","assign","data","json","onPayload","e","onError","id","currentMaxListeners","getMaxListeners","listenerCount","setMaxListeners","Promise","resolve","reject","error","resetMaxListeners","jsonrpc","params","onOpen","parseError","emit","message","toString"],"sources":["../../src/http.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}