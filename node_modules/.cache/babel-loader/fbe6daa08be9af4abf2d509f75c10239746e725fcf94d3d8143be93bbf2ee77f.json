{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n    return extendStatics(d, b);\n  };\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n    function __() {\n      this.constructor = d;\n    }\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar readable_stream_1 = require(\"readable-stream\");\nvar noop = function () {\n  return undefined;\n};\nvar PostMessageStream = /** @class */function (_super) {\n  __extends(PostMessageStream, _super);\n  function PostMessageStream(_a) {\n    var name = _a.name,\n      target = _a.target,\n      targetWindow = _a.targetWindow;\n    var _this = _super.call(this, {\n      objectMode: true\n    }) || this;\n    _this._name = name;\n    _this._target = target;\n    _this._targetWindow = targetWindow || window;\n    _this._origin = targetWindow ? '*' : location.origin;\n    // initialization flags\n    _this._init = false;\n    _this._haveSyn = false;\n    _this._onMessage = _this._onMessage.bind(_this);\n    window.addEventListener('message', _this._onMessage, false);\n    // send syncorization message\n    _this._write('SYN', null, noop);\n    _this.cork();\n    return _this;\n  }\n  PostMessageStream.prototype._destroy = function () {\n    // console.log('PostMessageStream: destroy');\n    window.removeEventListener('message', this._onMessage, false);\n  };\n  PostMessageStream.prototype._onMessage = function (event) {\n    var msg = event.data;\n    // validate message\n    if (this._origin !== '*' && event.origin !== this._origin) return;\n    if (event.source !== this._targetWindow) return;\n    if (typeof msg !== 'object') return;\n    if (msg.target !== this._name) return;\n    if (!msg.data) return;\n    if (!this._init) {\n      if (msg.data === 'SYN') {\n        this._haveSyn = true;\n        this._write('ACK', null, noop);\n      } else if (msg.data === 'ACK') {\n        this._init = true;\n        if (!this._haveSyn) {\n          this._write('ACK', null, noop);\n        }\n        this.uncork();\n      }\n    } else {\n      // forward message\n      try {\n        this.push(msg.data);\n      } catch (err) {\n        this.emit('error', err);\n      }\n    }\n  };\n  PostMessageStream.prototype._read = function () {\n    return undefined;\n  };\n  PostMessageStream.prototype._write = function (data, _encoding, cb) {\n    var message = {\n      target: this._target,\n      data: data\n    };\n    this._targetWindow.postMessage(message, this._origin);\n    cb(null);\n  };\n  return PostMessageStream;\n}(readable_stream_1.Duplex);\nexports.default = PostMessageStream;","map":{"version":3,"names":["readable_stream_1","require","noop","undefined","PostMessageStream","_super","__extends","_a","name","target","targetWindow","_this","call","objectMode","_name","_target","_targetWindow","window","_origin","location","origin","_init","_haveSyn","_onMessage","bind","addEventListener","_write","cork","prototype","_destroy","removeEventListener","event","msg","data","source","uncork","push","err","emit","_read","_encoding","cb","message","postMessage","Duplex"],"sources":["../../src/extension/PostMessageStream.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}