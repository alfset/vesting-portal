{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __exportStar = this && this.__exportStar || function (m, exports) {\n  for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nconst messageFormatter_1 = require(\"./messageFormatter\");\nclass PostMessageCommunicator {\n  constructor() {\n    let allowedOrigins = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;\n    let debugMode = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    this.allowedOrigins = null;\n    this.callbacks = new Map();\n    this.debugMode = false;\n    this.isServer = typeof window === 'undefined';\n    this.isValidMessage = _ref => {\n      let {\n        origin,\n        data,\n        source\n      } = _ref;\n      const emptyOrMalformed = !data;\n      const sentFromParentEl = !this.isServer && source === window.parent;\n      const majorVersionNumber = typeof data.version !== 'undefined' && parseInt(data.version.split('.')[0]);\n      const allowedSDKVersion = majorVersionNumber >= 1;\n      let validOrigin = true;\n      if (Array.isArray(this.allowedOrigins)) {\n        validOrigin = this.allowedOrigins.find(regExp => regExp.test(origin)) !== undefined;\n      }\n      return !emptyOrMalformed && sentFromParentEl && allowedSDKVersion && validOrigin;\n    };\n    this.logIncomingMessage = msg => {\n      console.info(\"Safe Apps SDK v1: A message was received from origin \".concat(msg.origin, \". \"), msg.data);\n    };\n    this.onParentMessage = msg => {\n      if (this.isValidMessage(msg)) {\n        this.debugMode && this.logIncomingMessage(msg);\n        this.handleIncomingMessage(msg.data);\n      }\n    };\n    this.handleIncomingMessage = payload => {\n      const {\n        id\n      } = payload;\n      const cb = this.callbacks.get(id);\n      if (cb) {\n        cb(payload);\n        this.callbacks.delete(id);\n      }\n    };\n    this.send = (method, params) => {\n      const request = messageFormatter_1.MessageFormatter.makeRequest(method, params);\n      if (this.isServer) {\n        throw new Error(\"Window doesn't exist\");\n      }\n      window.parent.postMessage(request, '*');\n      return new Promise((resolve, reject) => {\n        this.callbacks.set(request.id, response => {\n          if (!response.success) {\n            reject(new Error(response.error));\n            return;\n          }\n          resolve(response);\n        });\n      });\n    };\n    this.allowedOrigins = allowedOrigins;\n    this.debugMode = debugMode;\n    if (!this.isServer) {\n      window.addEventListener('message', this.onParentMessage);\n    }\n  }\n}\nexports.default = PostMessageCommunicator;\n__exportStar(require(\"./methods\"), exports);","map":{"version":3,"names":["messageFormatter_1","require","PostMessageCommunicator","constructor","allowedOrigins","arguments","length","undefined","debugMode","callbacks","Map","isServer","window","isValidMessage","_ref","origin","data","source","emptyOrMalformed","sentFromParentEl","parent","majorVersionNumber","version","parseInt","split","allowedSDKVersion","validOrigin","Array","isArray","find","regExp","test","logIncomingMessage","msg","console","info","concat","onParentMessage","handleIncomingMessage","payload","id","cb","get","delete","send","method","params","request","MessageFormatter","makeRequest","Error","postMessage","Promise","resolve","reject","set","response","success","error","addEventListener","exports","default","__exportStar"],"sources":["../../../src/communication/index.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}