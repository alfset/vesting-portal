{"ast":null,"code":"import { useCallback, useEffect, useState } from 'react';\nimport { useActiveWeb3React } from '../../hooks';\nimport { useActiveReact } from '../../hooks/useActiveReact';\nimport useDebounce from '../../hooks/useDebounce';\nimport useIsWindowVisible from '../../hooks/useIsWindowVisible';\nimport { updateBlockNumber } from './actions';\nimport { useDispatch } from 'react-redux';\n// import { useDispatch, useSelector } from 'react-redux'\n// import { AppState } from '../index'\n\n// import { useWeb3 } from '../../utils/tools/web3UtilsV2'\n\nexport default function Updater() {\n  const {\n    library,\n    chainId\n  } = useActiveWeb3React();\n  const {\n    chainId: nonevmChainId\n  } = useActiveReact();\n  const dispatch = useDispatch();\n  // const stateMt = useSelector<AppState, AppState['multicall']>(state => state.multicall)\n  // const destChainId = stateMt.useChainId\n  // console.log(stateMt)\n  const windowVisible = useIsWindowVisible();\n  const [state, setState] = useState({\n    chainId,\n    blockNumber: null\n  });\n  const blockNumberCallback = useCallback(blockNumber => {\n    setState(state => {\n      // console.log('时间', Date.now())\n      // console.log(state)\n      if (chainId === state.chainId) {\n        if (typeof state.blockNumber !== 'number') return {\n          chainId,\n          blockNumber\n        };\n        return {\n          chainId,\n          blockNumber: Math.max(blockNumber, state.blockNumber)\n        };\n      }\n      return state;\n    });\n  }, [chainId, setState]);\n\n  // attach/detach listeners\n  useEffect(() => {\n    if (!library || !chainId || !windowVisible || isNaN(nonevmChainId)) return undefined;\n    setState({\n      chainId,\n      blockNumber: null\n    });\n    library.getBlockNumber().then(blockNumberCallback).catch(error => console.error(\"Failed to get block number for chainId: \".concat(chainId), error));\n    library.on('block', blockNumberCallback);\n    return () => {\n      library.removeListener('block', blockNumberCallback);\n    };\n  }, [dispatch, chainId, library, blockNumberCallback, windowVisible, nonevmChainId]);\n  const debouncedState = useDebounce(state, 0);\n  useEffect(() => {\n    if (!debouncedState.chainId || !debouncedState.blockNumber || !windowVisible) return;\n    dispatch(updateBlockNumber({\n      chainId: debouncedState.chainId,\n      blockNumber: debouncedState.blockNumber\n    }));\n  }, [windowVisible, dispatch, debouncedState.blockNumber, debouncedState.chainId]);\n  // useEffect(() => {\n  //   console.log(destChainId)\n  //   if (!debouncedState.chainId || !debouncedState.blockNumber || !windowVisible) return\n\n  //   if (destChainId && !isNaN(destChainId)) {\n  //     useWeb3(destChainId, 'eth', 'getBlockNumber', []).then((res:any) => {\n  //       dispatch(updateBlockNumber({ chainId: destChainId, blockNumber: res }))\n  //     })\n  //   }\n\n  //   // console.log(debouncedState)\n\n  //   dispatch(updateBlockNumber({ chainId: debouncedState.chainId, blockNumber: debouncedState.blockNumber }))\n  // }, [windowVisible, dispatch, debouncedState.blockNumber, debouncedState.chainId])\n\n  return null;\n}","map":{"version":3,"names":["useCallback","useEffect","useState","useActiveWeb3React","useActiveReact","useDebounce","useIsWindowVisible","updateBlockNumber","useDispatch","Updater","library","chainId","nonevmChainId","dispatch","windowVisible","state","setState","blockNumber","blockNumberCallback","Math","max","isNaN","undefined","getBlockNumber","then","catch","error","console","concat","on","removeListener","debouncedState"],"sources":["/workspace/Planq-Dapps/vesting-portal/src/state/application/updater.ts"],"sourcesContent":["import { useCallback, useEffect, useState } from 'react'\nimport { useActiveWeb3React } from '../../hooks'\nimport { useActiveReact } from '../../hooks/useActiveReact'\nimport useDebounce from '../../hooks/useDebounce'\nimport useIsWindowVisible from '../../hooks/useIsWindowVisible'\nimport { updateBlockNumber } from './actions'\nimport { useDispatch } from 'react-redux'\n// import { useDispatch, useSelector } from 'react-redux'\n// import { AppState } from '../index'\n\n// import { useWeb3 } from '../../utils/tools/web3UtilsV2'\n\n\nexport default function Updater(): null {\n  const { library, chainId } = useActiveWeb3React()\n  const {chainId: nonevmChainId} = useActiveReact()\n  const dispatch = useDispatch()\n  // const stateMt = useSelector<AppState, AppState['multicall']>(state => state.multicall)\n  // const destChainId = stateMt.useChainId\n  // console.log(stateMt)\n  const windowVisible = useIsWindowVisible()\n\n  const [state, setState] = useState<{ chainId: number | undefined; blockNumber: number | null }>({\n    chainId,\n    blockNumber: null\n  })\n\n  const blockNumberCallback = useCallback(\n    (blockNumber: number) => {\n      setState(state => {\n        // console.log('时间', Date.now())\n        // console.log(state)\n        if (chainId === state.chainId) {\n          if (typeof state.blockNumber !== 'number') return { chainId, blockNumber }\n          return { chainId, blockNumber: Math.max(blockNumber, state.blockNumber) }\n        }\n        return state\n      })\n    },\n    [chainId, setState]\n  )\n\n  // attach/detach listeners\n  useEffect(() => {\n    if (!library || !chainId || !windowVisible || isNaN(nonevmChainId)) return undefined\n\n    setState({ chainId, blockNumber: null })\n\n    library\n      .getBlockNumber()\n      .then(blockNumberCallback)\n      .catch(error => console.error(`Failed to get block number for chainId: ${chainId}`, error))\n    \n    library.on('block', blockNumberCallback)\n    return () => {\n      library.removeListener('block', blockNumberCallback)\n    }\n  }, [dispatch, chainId, library, blockNumberCallback, windowVisible, nonevmChainId])\n\n  const debouncedState = useDebounce(state, 0)\n\n  useEffect(() => {\n    if (!debouncedState.chainId || !debouncedState.blockNumber || !windowVisible) return\n    dispatch(updateBlockNumber({ chainId: debouncedState.chainId, blockNumber: debouncedState.blockNumber }))\n  }, [windowVisible, dispatch, debouncedState.blockNumber, debouncedState.chainId])\n  // useEffect(() => {\n  //   console.log(destChainId)\n  //   if (!debouncedState.chainId || !debouncedState.blockNumber || !windowVisible) return\n\n  //   if (destChainId && !isNaN(destChainId)) {\n  //     useWeb3(destChainId, 'eth', 'getBlockNumber', []).then((res:any) => {\n  //       dispatch(updateBlockNumber({ chainId: destChainId, blockNumber: res }))\n  //     })\n  //   }\n\n  //   // console.log(debouncedState)\n\n  //   dispatch(updateBlockNumber({ chainId: debouncedState.chainId, blockNumber: debouncedState.blockNumber }))\n  // }, [windowVisible, dispatch, debouncedState.blockNumber, debouncedState.chainId])\n\n  return null\n}\n"],"mappings":"AAAA,SAASA,WAAW,EAAEC,SAAS,EAAEC,QAAQ,QAAQ,OAAO;AACxD,SAASC,kBAAkB,QAAQ,aAAa;AAChD,SAASC,cAAc,QAAQ,4BAA4B;AAC3D,OAAOC,WAAW,MAAM,yBAAyB;AACjD,OAAOC,kBAAkB,MAAM,gCAAgC;AAC/D,SAASC,iBAAiB,QAAQ,WAAW;AAC7C,SAASC,WAAW,QAAQ,aAAa;AACzC;AACA;;AAEA;;AAGA,eAAe,SAASC,OAAOA,CAAA,EAAS;EACtC,MAAM;IAAEC,OAAO;IAAEC;EAAQ,CAAC,GAAGR,kBAAkB,CAAC,CAAC;EACjD,MAAM;IAACQ,OAAO,EAAEC;EAAa,CAAC,GAAGR,cAAc,CAAC,CAAC;EACjD,MAAMS,QAAQ,GAAGL,WAAW,CAAC,CAAC;EAC9B;EACA;EACA;EACA,MAAMM,aAAa,GAAGR,kBAAkB,CAAC,CAAC;EAE1C,MAAM,CAACS,KAAK,EAAEC,QAAQ,CAAC,GAAGd,QAAQ,CAA8D;IAC9FS,OAAO;IACPM,WAAW,EAAE;EACf,CAAC,CAAC;EAEF,MAAMC,mBAAmB,GAAGlB,WAAW,CACpCiB,WAAmB,IAAK;IACvBD,QAAQ,CAACD,KAAK,IAAI;MAChB;MACA;MACA,IAAIJ,OAAO,KAAKI,KAAK,CAACJ,OAAO,EAAE;QAC7B,IAAI,OAAOI,KAAK,CAACE,WAAW,KAAK,QAAQ,EAAE,OAAO;UAAEN,OAAO;UAAEM;QAAY,CAAC;QAC1E,OAAO;UAAEN,OAAO;UAAEM,WAAW,EAAEE,IAAI,CAACC,GAAG,CAACH,WAAW,EAAEF,KAAK,CAACE,WAAW;QAAE,CAAC;MAC3E;MACA,OAAOF,KAAK;IACd,CAAC,CAAC;EACJ,CAAC,EACD,CAACJ,OAAO,EAAEK,QAAQ,CACpB,CAAC;;EAED;EACAf,SAAS,CAAC,MAAM;IACd,IAAI,CAACS,OAAO,IAAI,CAACC,OAAO,IAAI,CAACG,aAAa,IAAIO,KAAK,CAACT,aAAa,CAAC,EAAE,OAAOU,SAAS;IAEpFN,QAAQ,CAAC;MAAEL,OAAO;MAAEM,WAAW,EAAE;IAAK,CAAC,CAAC;IAExCP,OAAO,CACJa,cAAc,CAAC,CAAC,CAChBC,IAAI,CAACN,mBAAmB,CAAC,CACzBO,KAAK,CAACC,KAAK,IAAIC,OAAO,CAACD,KAAK,4CAAAE,MAAA,CAA4CjB,OAAO,GAAIe,KAAK,CAAC,CAAC;IAE7FhB,OAAO,CAACmB,EAAE,CAAC,OAAO,EAAEX,mBAAmB,CAAC;IACxC,OAAO,MAAM;MACXR,OAAO,CAACoB,cAAc,CAAC,OAAO,EAAEZ,mBAAmB,CAAC;IACtD,CAAC;EACH,CAAC,EAAE,CAACL,QAAQ,EAAEF,OAAO,EAAED,OAAO,EAAEQ,mBAAmB,EAAEJ,aAAa,EAAEF,aAAa,CAAC,CAAC;EAEnF,MAAMmB,cAAc,GAAG1B,WAAW,CAACU,KAAK,EAAE,CAAC,CAAC;EAE5Cd,SAAS,CAAC,MAAM;IACd,IAAI,CAAC8B,cAAc,CAACpB,OAAO,IAAI,CAACoB,cAAc,CAACd,WAAW,IAAI,CAACH,aAAa,EAAE;IAC9ED,QAAQ,CAACN,iBAAiB,CAAC;MAAEI,OAAO,EAAEoB,cAAc,CAACpB,OAAO;MAAEM,WAAW,EAAEc,cAAc,CAACd;IAAY,CAAC,CAAC,CAAC;EAC3G,CAAC,EAAE,CAACH,aAAa,EAAED,QAAQ,EAAEkB,cAAc,CAACd,WAAW,EAAEc,cAAc,CAACpB,OAAO,CAAC,CAAC;EACjF;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;;EAEA;;EAEA;EACA;;EAEA,OAAO,IAAI;AACb"},"metadata":{},"sourceType":"module","externalDependencies":[]}