{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n    return extendStatics(d, b);\n  };\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n    function __() {\n      this.constructor = d;\n    }\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n    return t;\n  };\n  return __assign.apply(this, arguments);\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WebSocketClient = void 0;\nvar events_1 = require(\"events\");\nvar ws_1 = __importDefault(require(\"ws\"));\nvar hash_1 = require(\"../util/hash\");\nvar escapeSingleQuotes = function (str) {\n  return str.replace(/'/g, \"\\\\'\");\n};\nfunction makeQueryParams(query) {\n  var queryBuilder = [];\n  for (var _i = 0, _a = Object.keys(query); _i < _a.length; _i++) {\n    var key = _a[_i];\n    var queryItem = void 0;\n    var value = query[key];\n    // if value is scalar\n    if (!Array.isArray(value)) {\n      switch (typeof value) {\n        case 'number':\n          queryItem = \"\".concat(key, \"=\").concat(value);\n          break;\n        case 'string':\n          queryItem = \"\".concat(key, \"='\").concat(escapeSingleQuotes(value), \"'\");\n          break;\n        default:\n          // Date\n          queryItem = \"\".concat(key, \"=\").concat(value.toISOString());\n      }\n    } else {\n      switch (value[0]) {\n        case '>':\n        case '<':\n        case '<=':\n        case '>=':\n          if (typeof value[1] !== 'number') {\n            queryItem = \"\".concat(key).concat(value[0]).concat(value[1].toISOString());\n          } else {\n            queryItem = \"\".concat(key).concat(value[0]).concat(value[1]);\n          }\n          break;\n        case 'CONTAINS':\n          queryItem = \"\".concat(key, \" CONTAINS '\").concat(escapeSingleQuotes(value[1]), \"'\");\n          break;\n        case 'EXISTS':\n          queryItem = \"\".concat(key, \" EXISTS\");\n          break;\n      }\n    }\n    queryBuilder.push(queryItem);\n  }\n  return queryBuilder.join(' AND ');\n}\n/**\n * An object repesenting a connection to a Terra node's WebSocket RPC endpoint.\n * This allows for subscribing to Tendermint events through WebSocket.\n *\n * ### Events\n * **error** emitted when error raises\n * **connect** emitted after connection establishment\n * **reconnect** emitted upon every attempt of reconnection\n * **destroyed** emitted when socket has been destroyed\n *\n * ### Example\n *\n * ```ts\n * import { WebSocketClient } from '@terra-money/terra.js';\n *\n * const wsclient = new WebSocketClient(\"ws://localhost:26657/websocket\");\n *\n * wsclient.subscribe('NewBlock', {}, (data) => {\n *    console.log(data.value);\n *\n *    // close after receiving one block.\n *    wsclient.destroy();\n * })\n *\n * wsclient.subscribe(\n * 'Tx',\n *  {\n *    'message.action': 'send',\n *    'message.sender': ['CONTAINS', 'terra1...'],\n *  },\n *  (data) => {\n *    console.log(data.value);\n *\n *   // close after receiving one send Tx\n *   wsclient.destroy();\n * });\n *\n * wsclient.start();\n * ```\n */\nvar WebSocketClient = /** @class */function (_super) {\n  __extends(WebSocketClient, _super);\n  /**\n   * WebSocketClient constructor\n   * @param URL The WebSocket endpoint URL on the Tendermint RPC server.\n   *            Ex: ws://localhost:26657/websocket\n   * @param reconnectCount 0 for not to attempt reconnect, -1 for infinite, > 0 for number of times to attempt\n   * @param reconnectInterval retry interval in milliseconds\n   */\n  function WebSocketClient(URL, reconnectCount, reconnectInterval) {\n    if (reconnectCount === void 0) {\n      reconnectCount = 0;\n    }\n    if (reconnectInterval === void 0) {\n      reconnectInterval = 1000;\n    }\n    var _this = _super.call(this) || this;\n    _this.URL = URL;\n    _this.reconnectCount = reconnectCount;\n    _this.reconnectInterval = reconnectInterval;\n    _this._reconnectCount = _this.reconnectCount;\n    _this.isConnected = false;\n    _this.shouldAttemptReconnect = !!_this.reconnectInterval;\n    return _this;\n  }\n  /**\n   * Destroys class as well as socket\n   */\n  WebSocketClient.prototype.destroy = function () {\n    this.shouldAttemptReconnect = false;\n    this.reconnectTimeoutId && clearTimeout(this.reconnectTimeoutId);\n    this.socket && this.socket.close();\n  };\n  WebSocketClient.prototype.start = function () {\n    this.socket = new ws_1.default(this.URL);\n    this.socket.onopen = this.onOpen.bind(this);\n    this.socket.onmessage = this.onMessage.bind(this);\n    this.socket.onclose = this.onClose.bind(this);\n    this.socket.onerror = function () {\n      return undefined;\n    };\n  };\n  WebSocketClient.prototype.onOpen = function () {\n    this.isConnected = true;\n    this.emit('connect');\n    // reset reconnectCount after connection establishment\n    this._reconnectCount = this.reconnectCount;\n    this.socket.send(JSON.stringify({\n      jsonrpc: '2.0',\n      method: 'subscribe',\n      params: [this.queryParams],\n      id: 1\n    }));\n  };\n  WebSocketClient.prototype.onMessage = function (message) {\n    try {\n      var parsedData = JSON.parse(message.data.toString());\n      if (this.callback && parsedData.result && parsedData.result.query === this.queryParams) {\n        // this.emit('message', parsedData.result.data);\n        this.callback(parsedData.result.data);\n      }\n    } catch (err) {\n      this.emit('error', err);\n    }\n  };\n  WebSocketClient.prototype.onClose = function () {\n    var _this = this;\n    this.isConnected = false;\n    if (this.shouldAttemptReconnect && (this._reconnectCount > 0 || this._reconnectCount === -1)) {\n      if (this._reconnectCount !== -1) {\n        this._reconnectCount--;\n      }\n      this.reconnectTimeoutId && clearTimeout(this.reconnectTimeoutId);\n      this.reconnectTimeoutId = setTimeout(function () {\n        _this.emit('reconnect');\n        _this.start();\n      }, this.reconnectInterval);\n    } else {\n      this.emit('destroyed');\n    }\n  };\n  WebSocketClient.prototype.subscribe = function (event, query, callback) {\n    this.queryParams = makeQueryParams(__assign({\n      'tm.event': event\n    }, query));\n    this.callback = callback;\n  };\n  WebSocketClient.prototype.subscribeTx = function (query, callback) {\n    var newCallback = function (d) {\n      d.value.TxResult.txhash = (0, hash_1.hashToHex)(d.value.TxResult.tx);\n      return callback(d);\n    };\n    this.subscribe('Tx', query, newCallback);\n  };\n  return WebSocketClient;\n}(events_1.EventEmitter);\nexports.WebSocketClient = WebSocketClient;","map":{"version":3,"names":["events_1","require","ws_1","__importDefault","hash_1","escapeSingleQuotes","str","replace","makeQueryParams","query","queryBuilder","_i","_a","Object","keys","length","key","queryItem","value","Array","isArray","concat","toISOString","push","join","WebSocketClient","_super","__extends","URL","reconnectCount","reconnectInterval","_this","call","_reconnectCount","isConnected","shouldAttemptReconnect","prototype","destroy","reconnectTimeoutId","clearTimeout","socket","close","start","default","onopen","onOpen","bind","onmessage","onMessage","onclose","onClose","onerror","undefined","emit","send","JSON","stringify","jsonrpc","method","params","queryParams","id","message","parsedData","parse","data","toString","callback","result","err","setTimeout","subscribe","event","__assign","subscribeTx","newCallback","d","TxResult","txhash","hashToHex","tx","EventEmitter","exports"],"sources":["../../src/client/WebSocketClient.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}