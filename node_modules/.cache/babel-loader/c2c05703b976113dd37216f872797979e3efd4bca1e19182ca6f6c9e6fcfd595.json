{"ast":null,"code":"import{useCallback,useEffect,useState}from'react';import{useActiveWeb3React}from'../../hooks';import{useActiveReact}from'../../hooks/useActiveReact';import useDebounce from'../../hooks/useDebounce';import useIsWindowVisible from'../../hooks/useIsWindowVisible';import{updateBlockNumber}from'./actions';import{useDispatch}from'react-redux';// import { useDispatch, useSelector } from 'react-redux'\n// import { AppState } from '../index'\n// import { useWeb3 } from '../../utils/tools/web3UtilsV2'\nexport default function Updater(){const{library,chainId}=useActiveWeb3React();const{chainId:nonevmChainId}=useActiveReact();const dispatch=useDispatch();// const stateMt = useSelector<AppState, AppState['multicall']>(state => state.multicall)\n// const destChainId = stateMt.useChainId\n// console.log(stateMt)\nconst windowVisible=useIsWindowVisible();const[state,setState]=useState({chainId,blockNumber:null});const blockNumberCallback=useCallback(blockNumber=>{setState(state=>{// console.log('时间', Date.now())\n// console.log(state)\nif(chainId===state.chainId){if(typeof state.blockNumber!=='number')return{chainId,blockNumber};return{chainId,blockNumber:Math.max(blockNumber,state.blockNumber)};}return state;});},[chainId,setState]);// attach/detach listeners\nuseEffect(()=>{if(!library||!chainId||!windowVisible||isNaN(nonevmChainId))return undefined;setState({chainId,blockNumber:null});library.getBlockNumber().then(blockNumberCallback).catch(error=>console.error(\"Failed to get block number for chainId: \".concat(chainId),error));library.on('block',blockNumberCallback);return()=>{library.removeListener('block',blockNumberCallback);};},[dispatch,chainId,library,blockNumberCallback,windowVisible,nonevmChainId]);const debouncedState=useDebounce(state,0);useEffect(()=>{if(!debouncedState.chainId||!debouncedState.blockNumber||!windowVisible)return;dispatch(updateBlockNumber({chainId:debouncedState.chainId,blockNumber:debouncedState.blockNumber}));},[windowVisible,dispatch,debouncedState.blockNumber,debouncedState.chainId]);// useEffect(() => {\n//   console.log(destChainId)\n//   if (!debouncedState.chainId || !debouncedState.blockNumber || !windowVisible) return\n//   if (destChainId && !isNaN(destChainId)) {\n//     useWeb3(destChainId, 'eth', 'getBlockNumber', []).then((res:any) => {\n//       dispatch(updateBlockNumber({ chainId: destChainId, blockNumber: res }))\n//     })\n//   }\n//   // console.log(debouncedState)\n//   dispatch(updateBlockNumber({ chainId: debouncedState.chainId, blockNumber: debouncedState.blockNumber }))\n// }, [windowVisible, dispatch, debouncedState.blockNumber, debouncedState.chainId])\nreturn null;}","map":{"version":3,"names":["useCallback","useEffect","useState","useActiveWeb3React","useActiveReact","useDebounce","useIsWindowVisible","updateBlockNumber","useDispatch","Updater","library","chainId","nonevmChainId","dispatch","windowVisible","state","setState","blockNumber","blockNumberCallback","Math","max","isNaN","undefined","getBlockNumber","then","catch","error","console","concat","on","removeListener","debouncedState"],"sources":["/workspace/Planq-Dapps/vesting-portal/src/state/application/updater.ts"],"sourcesContent":["import { useCallback, useEffect, useState } from 'react'\nimport { useActiveWeb3React } from '../../hooks'\nimport { useActiveReact } from '../../hooks/useActiveReact'\nimport useDebounce from '../../hooks/useDebounce'\nimport useIsWindowVisible from '../../hooks/useIsWindowVisible'\nimport { updateBlockNumber } from './actions'\nimport { useDispatch } from 'react-redux'\n// import { useDispatch, useSelector } from 'react-redux'\n// import { AppState } from '../index'\n\n// import { useWeb3 } from '../../utils/tools/web3UtilsV2'\n\n\nexport default function Updater(): null {\n  const { library, chainId } = useActiveWeb3React()\n  const {chainId: nonevmChainId} = useActiveReact()\n  const dispatch = useDispatch()\n  // const stateMt = useSelector<AppState, AppState['multicall']>(state => state.multicall)\n  // const destChainId = stateMt.useChainId\n  // console.log(stateMt)\n  const windowVisible = useIsWindowVisible()\n\n  const [state, setState] = useState<{ chainId: number | undefined; blockNumber: number | null }>({\n    chainId,\n    blockNumber: null\n  })\n\n  const blockNumberCallback = useCallback(\n    (blockNumber: number) => {\n      setState(state => {\n        // console.log('时间', Date.now())\n        // console.log(state)\n        if (chainId === state.chainId) {\n          if (typeof state.blockNumber !== 'number') return { chainId, blockNumber }\n          return { chainId, blockNumber: Math.max(blockNumber, state.blockNumber) }\n        }\n        return state\n      })\n    },\n    [chainId, setState]\n  )\n\n  // attach/detach listeners\n  useEffect(() => {\n    if (!library || !chainId || !windowVisible || isNaN(nonevmChainId)) return undefined\n\n    setState({ chainId, blockNumber: null })\n\n    library\n      .getBlockNumber()\n      .then(blockNumberCallback)\n      .catch(error => console.error(`Failed to get block number for chainId: ${chainId}`, error))\n    \n    library.on('block', blockNumberCallback)\n    return () => {\n      library.removeListener('block', blockNumberCallback)\n    }\n  }, [dispatch, chainId, library, blockNumberCallback, windowVisible, nonevmChainId])\n\n  const debouncedState = useDebounce(state, 0)\n\n  useEffect(() => {\n    if (!debouncedState.chainId || !debouncedState.blockNumber || !windowVisible) return\n    dispatch(updateBlockNumber({ chainId: debouncedState.chainId, blockNumber: debouncedState.blockNumber }))\n  }, [windowVisible, dispatch, debouncedState.blockNumber, debouncedState.chainId])\n  // useEffect(() => {\n  //   console.log(destChainId)\n  //   if (!debouncedState.chainId || !debouncedState.blockNumber || !windowVisible) return\n\n  //   if (destChainId && !isNaN(destChainId)) {\n  //     useWeb3(destChainId, 'eth', 'getBlockNumber', []).then((res:any) => {\n  //       dispatch(updateBlockNumber({ chainId: destChainId, blockNumber: res }))\n  //     })\n  //   }\n\n  //   // console.log(debouncedState)\n\n  //   dispatch(updateBlockNumber({ chainId: debouncedState.chainId, blockNumber: debouncedState.blockNumber }))\n  // }, [windowVisible, dispatch, debouncedState.blockNumber, debouncedState.chainId])\n\n  return null\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}