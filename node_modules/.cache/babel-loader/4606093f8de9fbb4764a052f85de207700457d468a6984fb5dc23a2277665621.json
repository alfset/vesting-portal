{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.SubscribeBlockTracker = void 0;\nconst json_rpc_random_id_1 = __importDefault(require(\"json-rpc-random-id\"));\nconst BaseBlockTracker_1 = require(\"./BaseBlockTracker\");\nconst createRandomId = (0, json_rpc_random_id_1.default)();\nclass SubscribeBlockTracker extends BaseBlockTracker_1.BaseBlockTracker {\n  constructor() {\n    let opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    // parse + validate args\n    if (!opts.provider) {\n      throw new Error('SubscribeBlockTracker - no provider specified.');\n    }\n    // BaseBlockTracker constructor\n    super(opts);\n    // config\n    this._provider = opts.provider;\n    this._subscriptionId = null;\n  }\n  async checkForLatestBlock() {\n    return await this.getLatestBlock();\n  }\n  async _start() {\n    if (this._subscriptionId === undefined || this._subscriptionId === null) {\n      try {\n        const blockNumber = await this._call('eth_blockNumber');\n        this._subscriptionId = await this._call('eth_subscribe', 'newHeads');\n        this._provider.on('data', this._handleSubData.bind(this));\n        this._newPotentialLatest(blockNumber);\n      } catch (e) {\n        this.emit('error', e);\n      }\n    }\n  }\n  async _end() {\n    if (this._subscriptionId !== null && this._subscriptionId !== undefined) {\n      try {\n        await this._call('eth_unsubscribe', this._subscriptionId);\n        this._subscriptionId = null;\n      } catch (e) {\n        this.emit('error', e);\n      }\n    }\n  }\n  _call(method) {\n    for (var _len = arguments.length, params = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      params[_key - 1] = arguments[_key];\n    }\n    return new Promise((resolve, reject) => {\n      this._provider.sendAsync({\n        id: createRandomId(),\n        method,\n        params,\n        jsonrpc: '2.0'\n      }, (err, res) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(res.result);\n        }\n      });\n    });\n  }\n  _handleSubData(_, response) {\n    var _a;\n    if (response.method === 'eth_subscription' && ((_a = response.params) === null || _a === void 0 ? void 0 : _a.subscription) === this._subscriptionId) {\n      this._newPotentialLatest(response.params.result.number);\n    }\n  }\n}\nexports.SubscribeBlockTracker = SubscribeBlockTracker;","map":{"version":3,"names":["json_rpc_random_id_1","__importDefault","require","BaseBlockTracker_1","createRandomId","default","SubscribeBlockTracker","BaseBlockTracker","constructor","opts","arguments","length","undefined","provider","Error","_provider","_subscriptionId","checkForLatestBlock","getLatestBlock","_start","blockNumber","_call","on","_handleSubData","bind","_newPotentialLatest","e","emit","_end","method","_len","params","Array","_key","Promise","resolve","reject","sendAsync","id","jsonrpc","err","res","result","_","response","_a","subscription","number","exports"],"sources":["../src/SubscribeBlockTracker.ts"],"sourcesContent":["import getCreateRandomId from 'json-rpc-random-id';\nimport { JsonRpcNotification, JsonRpcSuccess } from 'json-rpc-engine';\nimport { BaseBlockTracker } from './BaseBlockTracker';\nimport { Provider } from './types';\n\nconst createRandomId = getCreateRandomId();\n\nexport interface SubscribeBlockTrackerOptions {\n  provider?: Provider;\n  blockResetDuration?: number;\n}\n\ninterface SubscriptionNotificationParams {\n  subscription: string;\n  result: { number: string };\n}\n\nexport class SubscribeBlockTracker extends BaseBlockTracker {\n  private _provider: Provider;\n\n  private _subscriptionId: string | null;\n\n  constructor(opts: SubscribeBlockTrackerOptions = {}) {\n    // parse + validate args\n    if (!opts.provider) {\n      throw new Error('SubscribeBlockTracker - no provider specified.');\n    }\n\n    // BaseBlockTracker constructor\n    super(opts);\n    // config\n    this._provider = opts.provider;\n    this._subscriptionId = null;\n  }\n\n  async checkForLatestBlock(): Promise<string> {\n    return await this.getLatestBlock();\n  }\n\n  protected async _start(): Promise<void> {\n    if (this._subscriptionId === undefined || this._subscriptionId === null) {\n      try {\n        const blockNumber = (await this._call('eth_blockNumber')) as string;\n        this._subscriptionId = (await this._call(\n          'eth_subscribe',\n          'newHeads',\n        )) as string;\n        this._provider.on('data', this._handleSubData.bind(this));\n        this._newPotentialLatest(blockNumber);\n      } catch (e) {\n        this.emit('error', e);\n      }\n    }\n  }\n\n  protected async _end() {\n    if (this._subscriptionId !== null && this._subscriptionId !== undefined) {\n      try {\n        await this._call('eth_unsubscribe', this._subscriptionId);\n        this._subscriptionId = null;\n      } catch (e) {\n        this.emit('error', e);\n      }\n    }\n  }\n\n  private _call(method: string, ...params: unknown[]): Promise<unknown> {\n    return new Promise((resolve, reject) => {\n      this._provider.sendAsync(\n        {\n          id: createRandomId(),\n          method,\n          params,\n          jsonrpc: '2.0',\n        },\n        (err, res) => {\n          if (err) {\n            reject(err);\n          } else {\n            resolve((res as JsonRpcSuccess<unknown>).result);\n          }\n        },\n      );\n    });\n  }\n\n  private _handleSubData(\n    _: unknown,\n    response: JsonRpcNotification<SubscriptionNotificationParams>,\n  ): void {\n    if (\n      response.method === 'eth_subscription' &&\n      response.params?.subscription === this._subscriptionId\n    ) {\n      this._newPotentialLatest(response.params.result.number);\n    }\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}